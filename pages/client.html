
        // ============================================================================
        // ERROR HANDLING UTILITIES
        // ============================================================================
        function renderErrorState(containerId, title, detail, retryFn) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = `
                <div class="error-state">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">${title || 'Something went wrong'}</div>
                    <div class="error-detail">${detail || 'Please try again or refresh the page.'}</div>
                    ${retryFn ? `<button class="btn-retry" onclick="${retryFn}">‚Üª Try Again</button>` : ''}
                </div>
            `;
        }

        function getContextualErrorMessage(error, context) {
            const msg = error.message || String(error);
            if (msg.includes('429') || msg.includes('rate limit') || msg.includes('throttl')) {
                return { title: 'Too Many Requests', detail: 'The server is busy. Please wait a moment and try again.' };
            }
            if (msg.includes('401') || msg.includes('403') || msg.includes('unauthorized') || msg.includes('forbidden')) {
                return { title: 'Session Expired', detail: 'Your login session has expired. Please log in again.' };
            }
            if (msg.includes('404') || msg.includes('not found')) {
                return { title: 'Not Found', detail: `The requested ${context || 'resource'} could not be found.` };
            }
            if (msg.includes('500') || msg.includes('server error')) {
                return { title: 'Server Error', detail: 'Something went wrong on the server. Please try again shortly.' };
            }
            if (msg.includes('network') || msg.includes('Failed to fetch') || msg.includes('NetworkError')) {
                return { title: 'Connection Error', detail: 'Unable to connect to the server. Check your internet connection.' };
            }
            return { title: `Error ${context ? 'with ' + context : ''}`, detail: msg };
        }

        // ===== RETRY WITH EXPONENTIAL BACKOFF =====
        async function fetchWithRetry(url, options, maxRetries = 3) {
            let lastError;
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const resp = await fetch(url, options);
                    if (resp.status === 429 && attempt < maxRetries) {
                        const waitMs = Math.min(1000 * Math.pow(2, attempt), 8000);
                        showToast(`Rate limited. Retrying in ${waitMs/1000}s...`, 'info');
                        await new Promise(r => setTimeout(r, waitMs));
                        continue;
                    }
                    return resp;
                } catch(err) {
                    lastError = err;
                    if (attempt < maxRetries && (err.message.includes('network') || err.message.includes('Failed to fetch'))) {
                        const waitMs = Math.min(1000 * Math.pow(2, attempt), 8000);
                        await new Promise(r => setTimeout(r, waitMs));
                        continue;
                    }
                    throw err;
                }
            }
            throw lastError;
        }
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Portal - Crimson & Quill</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ============================================
           CSS VARIABLES - MATCH MAIN BRANDING
           ============================================ */
        :root {
            /* Brand Colors - Black & Gold */
            --primary: #000000;
            --gold: #B8860B;
            --gold-light: #D4A84B;
            --gold-dark: #8B6914;

            /* Neutral Colors */
            --dark: #000000;
            --gray: #4A4A4A;
            --gray-light: #888888;
            --silver: #E0E0E0;
            --off-white: #FAFAFA;
            --white: #FFFFFF;

            /* Typography */
            --font-sans: 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);

            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-base: 0.3s ease;
        }

        /* ============================================
           RESET & BASE STYLES
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            font-family: var(--font-sans);
            background: var(--white);
            color: var(--dark);
        }

        body {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* ============================================
           LOADING OVERLAY
           ============================================ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            display: none;
            opacity: 0;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(184, 134, 11, 0.3);
            border-top: 4px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .container {
            display: flex;
            height: 100vh;
            background: var(--white);
        }

        /* ============================================
           HEADER
           ============================================ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: var(--white);
            border-bottom: 1px solid var(--silver);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-text {
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--dark);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            line-height: 1;
        }

        .logo-amp {
            font-family: 'Times New Roman', Georgia, serif;
            color: var(--gold);
            font-weight: 400;
            font-style: italic;
            margin: 0 0.1em;
        }

        .portal-badge {
            background: var(--gold);
            color: var(--white);
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--gray-light);
            font-size: 14px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 16px;
        }

        .logout-btn {
            background: var(--off-white);
            border: 1px solid var(--silver);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
            transition: all var(--transition-base);
            font-family: var(--font-sans);
        }

        .logout-btn:hover {
            background: var(--silver);
            border-color: var(--gray);
        }

        /* ============================================
           SIDEBAR
           ============================================ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 80px;
            width: 250px;
            height: calc(100vh - 80px);
            background: var(--white);
            border-right: 1px solid var(--silver);
            padding: 20px 0;
            overflow-y: auto;
            z-index: 50;
            transition: transform 0.3s ease;
        }

        .nav-item {
            padding: 15px 20px;
            color: var(--gray-light);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--transition-base);
            border-left: 3px solid transparent;
            position: relative;
        }

        .nav-item:hover {
            color: var(--gold);
            background: rgba(184, 134, 11, 0.05);
        }

        .nav-item.active {
            color: var(--gold);
            background: rgba(184, 134, 11, 0.08);
            border-left-color: var(--gold);
            font-weight: 600;
        }

        .nav-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--gold);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
            margin-left: 8px;
        }

        .nav-badge:empty {
            display: none;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */
        .content-wrapper {
            margin-left: 250px;
            margin-top: 80px;
            width: calc(100% - 250px);
            min-height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .content {
            padding: 40px;
            max-width: 1280px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ============================================
           CARDS
           ============================================ */
        .card {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            border: 1px solid var(--silver);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-title {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .welcome-card {
            background: linear-gradient(135deg, var(--dark) 0%, #1a1a1a 100%);
            color: var(--white);
            border: none;
        }

        .welcome-card .card-title {
            color: var(--gold);
        }

        .welcome-card p {
            font-size: 16px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        /* ============================================
           STATS GRID
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-xl);
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: var(--space-xl);
            border-radius: var(--radius-md);
            border: 1px solid var(--silver);
            text-align: center;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
        }

        .stat-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .stat-value {
            font-family: 'Inter', sans-serif;
            font-size: 36px;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-label {
            font-size: 13px;
            color: var(--gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* ============================================
           TABLES
           ============================================ */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead th {
            background: var(--off-white);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--silver);
        }

        tbody tr {
            border-bottom: 1px solid var(--silver);
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--off-white);
        }

        td {
            padding: 12px;
            color: var(--gray);
        }

        .table-responsive {
            position: relative;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 16px;
        }

        .table-responsive::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.9));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .table-responsive.has-overflow::after {
            opacity: 1;
        }

        /* ============================================
           BADGES
           ============================================ */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-active {
            background: rgba(76, 175, 80, 0.2);
            color: #2e7d32;
        }

        .badge-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #f57f17;
        }

        .badge-closed {
            background: rgba(158, 158, 158, 0.2);
            color: #616161;
        }

        .badge-onhold {
            background: rgba(255, 152, 0, 0.2);
            color: #e65100;
        }

        .badge-high {
            background: rgba(244, 67, 54, 0.2);
            color: #c62828;
        }

        .badge-normal {
            background: rgba(33, 150, 243, 0.2);
            color: #1565c0;
        }

        .badge-low {
            background: rgba(158, 158, 158, 0.2);
            color: #616161;
        }

        .badge-paid {
            background: rgba(76, 175, 80, 0.2);
            color: #2e7d32;
        }

        .badge-overdue {
            background: rgba(244, 67, 54, 0.2);
            color: #c62828;
        }

        /* ============================================
           LIST ITEMS
           ============================================ */
        .list-item {
            padding: 15px;
            border-bottom: 1px solid var(--silver);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .list-item:hover {
            background: var(--off-white);
            border-left-color: var(--gold);
        }

        .list-item-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 15px;
        }

        .list-item-meta {
            font-size: 13px;
            color: var(--gray-light);
        }

        .list-item-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--silver);
        }

        .list-item-details.show {
            display: block;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--gray);
            width: 150px;
        }

        .detail-value {
            color: var(--dark);
            flex: 1;
        }

        /* ============================================
           EMPTY STATE
           ============================================ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: var(--gray-light);
        }

        /* ============================================
           ERROR & SUCCESS MESSAGES
           ============================================ */
        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #c62828;
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-xl);
            font-size: 14px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #2e7d32;
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-xl);
            font-size: 14px;
        }

        /* ============================================
           LOADING STATE
           ============================================ */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--gold);
        }

        .mini-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(184, 134, 11, 0.3);
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* ============================================
           QUICK LINKS
           ============================================ */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .quick-link {
            background: var(--gold);
            color: var(--white);
            padding: 15px;
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all var(--transition-base);
            text-decoration: none;
            display: block;
            border: none;
            font-family: var(--font-sans);
        }

        .quick-link:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ============================================
           FORMS
           ============================================ */
        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--dark);
            font-size: 14px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            font-family: var(--font-sans);
            font-size: 14px;
            border: 1px solid var(--silver);
            border-radius: var(--radius-sm);
            background: var(--white);
            transition: all var(--transition-base);
            color: var(--dark);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: 10px 16px;
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
        }

        .btn-gold {
            background: var(--gold);
            color: var(--white);
        }

        .btn-gold:hover {
            background: var(--gold-light);
        }

        .btn-primary {
            background: var(--dark);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--gray);
        }

        .btn-secondary {
            background: var(--off-white);
            color: var(--dark);
            border: 1px solid var(--silver);
        }

        .btn-secondary:hover {
            background: var(--silver);
        }

        /* ============================================
           MODAL
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 30px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 95%;
            margin: 20px auto;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--silver);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-light);
        }

        .modal-close:hover {
            color: var(--dark);
        }

        /* ============================================
           MOBILE RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .header {
                padding: 0 15px;
            }

            .logo-text {
                font-size: 18px;
            }

            .header-right {
                gap: 15px;
            }

            .user-info {
                display: none;
            }

            .sidebar {
                width: 0;
                transform: translateX(-100%);
            }

            .sidebar.open {
                width: 250px;
                transform: translateX(0);
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .content-wrapper {
                margin-left: 0;
                width: 100%;
            }

            .content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .toggle-sidebar-btn {
                display: block;
                background: none;
                border: none;
                color: var(--dark);
                font-size: 20px;
                cursor: pointer;
                padding: 5px;
            }

            .quick-links {
                grid-template-columns: 1fr;
            }

            .invoice-modal-content {
                max-width: 100%;
                width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                min-height: 100vh;
            }

            .modal-content {
                max-width: 100%;
                width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                min-height: 100vh;
                padding: 20px;
            }

            .modal input, .modal select, .modal textarea {
                font-size: 16px !important;
            }

            .modal-footer {
                flex-direction: column;
                gap: 8px;
            }

            .modal-footer .btn {
                width: 100%;
            }

            .main-content, .content-body {
                padding: 15px;
                overflow-x: hidden;
            }

            .stat-cards, .stats-grid, .dashboard-stats {
                flex-wrap: wrap;
            }

            .stat-cards > div, .stat-card {
                min-width: calc(50% - 8px);
                flex: 1 1 calc(50% - 8px);
            }
        }

        @media (max-width: 480px) {
            .stat-cards > div, .stat-card {
                min-width: 100%;
                flex: 1 1 100%;
            }
        }

        @media (min-width: 769px) {
            .toggle-sidebar-btn {
                display: none;
            }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ============================================
           FILE UPLOAD
           ============================================ */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .upload-area {
            border: 2px dashed var(--silver);
            border-radius: var(--radius-md);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--off-white);
        }

        .upload-area:hover {
            border-color: var(--gold);
            background: rgba(184, 134, 11, 0.02);
        }

        .upload-area.drag-over {
            border-color: var(--gold);
            background: rgba(184, 134, 11, 0.1);
        }

        .upload-area-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-area-text {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .upload-area-hint {
            color: var(--gray-light);
            font-size: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--silver);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gold);
            transition: width 0.3s ease;
            width: 0%;
        }

        /* ============================================
           INVOICE MODAL
           ============================================ */
        .invoice-modal-content {
            max-width: 800px;
            width: 95%;
            margin: 20px auto;
            max-height: 90vh;
            overflow-y: auto;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--silver);
        }

        .invoice-title {
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 28px;
            font-weight: 600;
            color: var(--dark);
        }

        .invoice-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--off-white);
            border-radius: var(--radius-md);
        }

        .invoice-info-item {
            display: flex;
            flex-direction: column;
        }

        .invoice-info-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .invoice-info-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
        }

        .invoice-items {
            margin-bottom: 30px;
        }

        .invoice-items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .invoice-items-table thead tr {
            background: var(--off-white);
        }

        .invoice-items-table th,
        .invoice-items-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--silver);
            font-size: 13px;
        }

        .invoice-items-table th {
            font-weight: 600;
            color: var(--dark);
        }

        .invoice-items-table td {
            color: var(--gray);
        }

        .invoice-totals {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            background: var(--off-white);
            border-radius: var(--radius-md);
            text-align: right;
        }

        .invoice-total-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .invoice-total-row.final {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            padding-top: 10px;
            border-top: 2px solid var(--silver);
        }

        .invoice-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .sender-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-right: 8px;
        }

        .sender-badge-staff {
            background: rgba(33, 150, 243, 0.2);
            color: #1565c0;
        }

        .sender-badge-client {
            background: rgba(184, 134, 11, 0.2);
            color: var(--gold-dark);
        }

        .event-matter-ref {
            display: inline-block;
            background: rgba(184, 134, 11, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--gold-dark);
            font-weight: 600;
            margin-left: 8px;
        }

        /* ============================================
           FOOTER
           ============================================ */
        .portal-footer {
            background: var(--dark);
            color: var(--white);
            padding: 6rem 0 2rem;
            margin-top: 60px;
        }
        .footer-inner {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr;
            gap: 3rem;
            margin-bottom: 3rem;
        }
        .footer-brand .footer-logo {
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 1.5rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--white);
            margin-bottom: 1rem;
        }
        .footer-brand .footer-logo .logo-amp {
            color: var(--gold);
            font-style: italic;
            margin: 0 0.1em;
        }
        .footer-brand .footer-logo .logo-name {
            color: var(--white);
        }
        .footer-tagline {
            color: var(--gray-light);
            font-size: 0.9375rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        .footer-social {
            display: flex;
            gap: 0.75rem;
        }
        .social-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .social-icon:hover {
            background: var(--gold);
        }
        .footer-col {
            display: flex;
            flex-direction: column;
        }
        .footer-col h4 {
            color: var(--white);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        .footer-col a, .footer-col p {
            color: var(--gray-light);
            font-size: 0.9375rem;
            text-decoration: none;
            line-height: 1.6;
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }
        .footer-col a:hover {
            color: var(--white);
        }
        .footer-bottom {
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .footer-bottom span {
            color: var(--gray-light);
            font-size: 0.875rem;
        }
        .footer-legal {
            display: flex;
            gap: 2rem;
        }
        .footer-legal a {
            color: var(--gray-light);
            font-size: 0.875rem;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .footer-legal a:hover {
            color: var(--white);
        }
        @media (max-width: 1024px) {
            .footer-grid {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
        }
        @media (max-width: 640px) {
            .footer-grid {
                grid-template-columns: 1fr;
            }
            .footer-bottom {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        /* ============================================
           MATTER FILTER
           ============================================ */
        .filter-group {
            margin-bottom: 20px;
        }

        .filter-label {
            display: block;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 13px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--silver);
            border-radius: var(--radius-sm);
            font-size: 13px;
            cursor: pointer;
            background: var(--white);
            color: var(--dark);
        }

        /* Error state with retry */
        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        .error-state .error-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        .error-state .error-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        .error-state .error-detail {
            font-size: 14px;
            color: var(--gray-light);
            margin-bottom: 16px;
        }
        .btn-retry {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 20px;
            background: var(--gold);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-retry:hover {
            background: var(--gold-dark);
        }

        /* ===== LOADING BUTTON STATES ===== */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-top: -8px;
            margin-left: -8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }
        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }

        /* ===== SKELETON LOADING ===== */
        .skeleton-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
            min-height: 20px;
        }
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-card {
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            background: #f5f5f5;
        }
        .skeleton-card .skeleton-line {
            height: 14px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: linear-gradient(90deg, #e8e8e8 25%, #d8d8d8 50%, #e8e8e8 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
        }
        .skeleton-line.short { width: 40%; }
        .skeleton-line.medium { width: 65%; }
        .skeleton-line.long { width: 90%; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="toggle-sidebar-btn" id="toggleSidebar">‚ò∞</button>
            <div class="logo-text">Crimson <span class="logo-amp">&</span> Quill</div>
            <div class="portal-badge">Client Portal</div>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">C</div>
                <div id="userName">Welcome</div>
            </div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="nav-item active" data-tab="dashboard">
            <div class="nav-icon">üìä</div>
            <div>Dashboard</div>
        </div>
        <div class="nav-item" data-tab="matters">
            <div class="nav-icon">üìã</div>
            <div>Matters</div>
        </div>
        <div class="nav-item" data-tab="documents">
            <div class="nav-icon">üìÑ</div>
            <div>Documents</div>
        </div>
        <div class="nav-item" data-tab="calendar">
            <div class="nav-icon">üìÖ</div>
            <div>Calendar</div>
        </div>
        <div class="nav-item" data-tab="messages">
            <div class="nav-icon">üí¨</div>
            <div>Messages<span id="messagesBadge" class="nav-badge"></span></div>
        </div>
        <div class="nav-item" data-tab="billing">
            <div class="nav-icon">üí∞</div>
            <div>Billing</div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-wrapper" id="contentWrapper">
        <div class="content" id="content">
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <!-- Will be populated by JS -->
            </div>

            <!-- Matters Tab -->
            <div class="tab-content" id="matters">
                <!-- Will be populated by JS -->
            </div>

            <!-- Documents Tab -->
            <div class="tab-content" id="documents">
                <!-- Will be populated by JS -->
            </div>

            <!-- Calendar Tab -->
            <div class="tab-content" id="calendar">
                <!-- Will be populated by JS -->
            </div>

            <!-- Messages Tab -->
            <div class="tab-content" id="messages">
                <!-- Will be populated by JS -->
            </div>

            <!-- Billing Tab -->
            <div class="tab-content" id="billing">
                <!-- Will be populated by JS -->
            </div>

            <!-- Footer -->
            <footer class="portal-footer">
                <div class="footer-inner">
                    <div class="footer-grid">
                        <div class="footer-brand">
                            <div class="footer-logo"><span class="logo-name">CRIMSON</span> <span class="logo-amp">&amp;</span> <span class="logo-name">QUILL</span></div>
                            <p class="footer-tagline">Exceptional legal service for Uganda's most complex challenges.</p>
                            <div class="footer-social">
                                <a href="https://linkedin.com" target="_blank" class="social-icon">in</a>
                                <a href="https://x.com" target="_blank" class="social-icon">ùïè</a>
                            </div>
                        </div>
                        <div class="footer-col">
                            <h4>Practice Areas</h4>
                            <a href="/">Corporate &amp; Commercial</a>
                            <a href="/">Banking &amp; Finance</a>
                            <a href="/">Regulatory &amp; Compliance</a>
                            <a href="/">Dispute Resolution</a>
                            <a href="/">Intellectual Property</a>
                        </div>
                        <div class="footer-col">
                            <h4>Quick Links</h4>
                            <a href="/">About Us</a>
                            <a href="/">Our Team</a>
                            <a href="/">Insights</a>
                            <a href="/">Careers</a>
                            <a href="/">Contact Us</a>
                        </div>
                        <div class="footer-col">
                            <h4>Contact Info</h4>
                            <p>Ntinda, Kiwatule Rd, Mpungu Close<br>Kampala, Uganda</p>
                            <p>+256 778 171 215</p>
                            <p>info@cqadvocates.com</p>
                        </div>
                    </div>
                    <div class="footer-bottom">
                        <span>&copy; 2026 Crimson &amp; Quill. All rights reserved.</span>
                        <div class="footer-legal">
                            <a href="/">Privacy Policy</a>
                            <a href="/">Terms of Service</a>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Message Modal -->
    <div class="modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Send Message</h3>
                <button class="modal-close" id="closeMessageModal">&times;</button>
            </div>
            <form id="messageForm">
                <div class="form-group">
                    <label class="form-label" for="msgSubject">Subject</label>
                    <input class="form-input" id="msgSubject" type="text" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="msgMatter">Matter</label>
                    <select class="form-select" id="msgMatter" required>
                        <option value="">Select a matter...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="msgBody">Message</label>
                    <textarea class="form-textarea" id="msgBody" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelMessageBtn">Cancel</button>
                    <button type="submit" class="btn btn-gold">Send</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Document Upload Modal -->
    <div class="modal" id="uploadModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Upload Document</h3>
                <button class="modal-close" id="closeUploadModal">&times;</button>
            </div>
            <form id="uploadForm">
                <div class="form-group">
                    <label class="form-label" for="uploadMatter">Select Matter</label>
                    <select class="form-select" id="uploadMatter" required>
                        <option value="">-- Choose a matter --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Select File</label>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-area-icon">üìÑ</div>
                        <div class="upload-area-text">Click to upload or drag and drop</div>
                        <div class="upload-area-hint">Max file size: 10 MB</div>
                        <input type="file" id="fileInput" style="display: none;">
                    </div>
                    <div id="fileName" style="margin-top: 10px; font-size: 13px; color: var(--gray);"></div>
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div id="progressText" style="font-size: 12px; color: var(--gray-light); margin-top: 8px;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelUploadBtn">Cancel</button>
                    <button type="submit" class="btn btn-gold" id="uploadSubmitBtn">Upload</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content invoice-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Invoice Details</h3>
                <button class="modal-close" id="closeInvoiceModal">&times;</button>
            </div>
            <div id="invoiceContent">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div class="modal" id="docViewerModal" style="z-index: 1001;">
        <div style="background: #fff; border-radius: 12px; width: 90vw; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 25px 60px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid #eee; background: #fafafa;">
                <div style="display: flex; align-items: center; gap: 10px; min-width: 0; flex: 1;">
                    <span id="docViewerIcon" style="font-size: 20px;">üìÑ</span>
                    <h3 id="docViewerTitle" style="font-size: 15px; font-weight: 600; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Document</h3>
                    <span id="docViewerMeta" style="color: #888; font-size: 11px; flex-shrink: 0;"></span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
                    <a id="docViewerDownload" href="#" download="" class="btn btn-gold" style="padding: 5px 12px; font-size: 12px; text-decoration: none;">Download</a>
                    <a id="docViewerOpenNew" href="#" target="_blank" class="btn btn-secondary" style="padding: 5px 12px; font-size: 12px; text-decoration: none; display: none;">Open</a>
                    <button onclick="closeDocViewer()" style="background: none; border: none; font-size: 22px; cursor: pointer; color: #666; padding: 0 4px; line-height: 1;">&times;</button>
                </div>
            </div>
            <div id="docViewerContent" style="flex: 1; overflow: auto; min-height: 200px; background: #f5f5f5;"></div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" style="position: fixed; top: 80px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px;"></div>

    <script>
        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        function setButtonLoading(btn, loading, originalText) {
            if (!btn) return;
            if (loading) {
                btn.dataset.originalText = btn.textContent;
                btn.textContent = 'Processing...';
                btn.classList.add('btn-loading');
                btn.disabled = true;
            } else {
                btn.textContent = btn.dataset.originalText || originalText || 'Save';
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        function showSkeletonLoading(containerId, count) {
            const container = document.getElementById(containerId);
            if (!container) return;
            let html = '';
            for (let i = 0; i < (count || 3); i++) {
                html += '<div class="skeleton-card"><div class="skeleton-line long"></div><div class="skeleton-line medium"></div><div class="skeleton-line short"></div></div>';
            }
            container.innerHTML = html;
        }

        // ============================================================================
        // GLOBAL STATE
        // ============================================================================
        let currentTab = 'dashboard';
        let portalData = {};
        let clientProfile = { name: null, email: null, matterNames: [], matterIds: [] };

        // ============================================================================
        // UTILITIES
        // ============================================================================
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch {
                return dateString;
            }
        }

        function formatCurrency(value, currency = 'UGX') {
            if (!value) {
                return currency === 'USD' ? '$0.00' : 'UGX 0';
            }
            const num = parseFloat(value);
            if (isNaN(num)) {
                return currency === 'USD' ? '$0.00' : 'UGX 0';
            }

            if (currency === 'USD') {
                return '$' + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else {
                // UGX formatting - no decimal places, with commas
                return 'UGX ' + Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
        }

        function getInitial(email) {
            if (!email) return 'C';
            return email.charAt(0).toUpperCase();
        }
        function timeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            if (seconds < 2592000) return Math.floor(seconds / 604800) + 'w ago';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getCookie(name) {
            const nameEQ = name + '=';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.indexOf(nameEQ) === 0) {
                    return decodeURIComponent(cookie.substring(nameEQ.length));
                }
            }
            return '';
        }

        function updateUnreadBadge() {
            const messagesData = portalData.messages || { items: [] };
            const messages = messagesData.items || [];
            const clientEmail = clientProfile.email || '';
            const unreadCount = messages.filter(m => {
                const isRead = m.Read === 'true' || m.Read === true;
                const senderEmail = m.SenderEmail || m.Author_x0020_Email || '';
                const isFromClient = senderEmail.toLowerCase() === clientEmail.toLowerCase();
                return !isRead && !isFromClient;
            }).length;
            
            const badge = document.getElementById('messagesBadge');
            if (badge) {
                badge.textContent = unreadCount > 0 ? unreadCount : '';
            }
        }

        function filterMessages() {
            const search = (document.getElementById('messageSearch')?.value || '').toLowerCase();
            const priority = document.getElementById('messagePriorityFilter')?.value || '';
            
            const messagesData = portalData.messages || { items: [] };
            const messages = messagesData.items || [];
            const filtered = messages.filter(m => {
                const matchesSearch = !search || 
                    (m.Title || '').toLowerCase().includes(search) ||
                    (m.Message_x0020_Body || '').toLowerCase().includes(search) ||
                    (m.SenderEmail || m.Author_x0020_Email || '').toLowerCase().includes(search);
                const matchesPriority = !priority || (m.Priority || '').toLowerCase() === priority.toLowerCase();
                return matchesSearch && matchesPriority;
            });
            
            renderFilteredMessages(filtered);
        }

        function renderFilteredMessages(filtered) {
            const clientEmail = clientProfile.email || '';
            let html = '';
            
            if (filtered.length === 0) {
                html = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><div class="empty-state-title">No Messages</div><div class="empty-state-text">No messages match your search.</div></div>';
            } else {
                filtered.forEach((message, index) => {
                    const priority = message.Priority || 'Normal';
                    const priorityBadgeClass = `badge-${priority.toLowerCase()}`;
                    const unreadStyle = message.Read
                        ? ''
                        : 'border-left: 4px solid var(--gold); background: rgba(184, 134, 11, 0.12);';
                    const titleWeight = message.Read ? '500' : '700';
                    
                    const senderEmail = message.SenderEmail || message.Author_x0020_Email || '';
                    const isClientMessage = senderEmail.toLowerCase() === clientEmail.toLowerCase();
                    const sender = isClientMessage ? 'You' : 'Staff';
                    const senderBadgeClass = isClientMessage ? 'sender-badge-client' : 'sender-badge-staff';
                    
                    // Find original index in full messages array
                    const messagesData = portalData.messages || { items: [] };
                    const originalIdx = (messagesData.items || []).findIndex(m => m === message);
                    
                    html += `
                        <div class="list-item" onclick="toggleMessageDetails(this, ${originalIdx})" style="${unreadStyle}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div class="list-item-title" style="font-weight: ${titleWeight};">
                                        <span class="sender-badge ${senderBadgeClass}">${sender}</span>
                                        ${message.Title || 'No Subject'}
                                        ${!message.Read ? '<span style="display: inline-block; width: 8px; height: 8px; background: var(--gold); border-radius: 50%; margin-left: 8px; vertical-align: middle;"></span>' : ''}
                                    </div>
                                    <div class="list-item-meta">Matter: ${message.Matter_x0020_ID || 'N/A'} ‚Ä¢ <span title="${formatDate(message.Created)}">${timeAgo(message.Created)}</span></div>
                                </div>
                                <span class="badge ${priorityBadgeClass}">${priority}</span>
                            </div>
                            <div class="list-item-details" id="msg-details-${originalIdx}">
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--silver);">
                                    <div style="color: var(--gray); line-height: 1.6;">${message.Message_x0020_Body || 'No content'}</div>
                                    <div style="margin-top: 15px; font-size: 12px; color: var(--gray-light);">
                                        ${!message.Read ? '<span style="background: var(--gold); color: white; padding: 2px 8px; border-radius: 3px; margin-right: 10px;">Unread</span>' : ''}
                                        ${isClientMessage ? '<span style="background: rgba(184, 134, 11, 0.2); color: var(--gold-dark); padding: 2px 8px; border-radius: 3px; margin-right: 10px;">You sent this</span>' : ''}
                                        Received: ${formatDate(message.Created)}
                                    </div>
                                    ${!isClientMessage ? `<button class="btn btn-sm" style="margin-top: 15px; padding: 6px 12px; font-size: 12px; background: var(--gold); color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="event.stopPropagation(); replyToMessageClient('${(message.Title || 'Message').replace(/'/g, "\'")}', '${(message.Matter_x0020_ID || 'N/A').replace(/'/g, "\'")}')">Reply</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const container = document.getElementById('messages');
            container.innerHTML = '<div class="card"><div class="card-title">Messages</div>' + 
                '<button class="btn btn-gold" style="margin-bottom: 20px;" onclick="openMessageModal()">New Message</button>' +
                '<div style="margin-bottom: 16px; display: flex; gap: 10px; align-items: center;">' +
                '<input type="text" id="messageSearch" placeholder="Search messages..." ' +
                'style="flex:1; padding: 10px 14px; border: 1px solid var(--silver); border-radius: var(--radius-sm); font-size: 14px; font-family: inherit;" ' +
                'oninput="filterMessages()">' +
                '<select id="messagePriorityFilter" onchange="filterMessages()" ' +
                'style="padding: 10px 14px; border: 1px solid var(--silver); border-radius: var(--radius-sm); font-size: 14px; font-family: inherit;">' +
                '<option value="">All Priorities</option>' +
                '<option value="High">High</option>' +
                '<option value="Medium">Medium</option>' +
                '<option value="Low">Low</option>' +
                '</select></div>' + html + '</div>';
        }


        function checkTableOverflow() {
            document.querySelectorAll('.table-responsive').forEach(el => {
                if (el.scrollWidth > el.clientWidth) {
                    el.classList.add('has-overflow');
                } else {
                    el.classList.remove('has-overflow');
                }
            });
        }
        window.addEventListener('resize', checkTableOverflow);

        // ============================================================================

        // ============================================================================
        // ERROR HANDLING UTILITIES
        // ============================================================================
        function renderErrorState(containerId, title, detail, retryFn) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = `
                <div class="error-state">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">${title || 'Something went wrong'}</div>
                    <div class="error-detail">${detail || 'Please try again or refresh the page.'}</div>
                    ${retryFn ? `<button class="btn-retry" onclick="${retryFn}">‚Üª Try Again</button>` : ''}
                </div>
            `;
        }

        function getContextualErrorMessage(error, context) {
            const msg = error.message || String(error);
            if (msg.includes('429') || msg.includes('rate limit') || msg.includes('throttl')) {
                return { title: 'Too Many Requests', detail: 'The server is busy. Please wait a moment and try again.' };
            }
            if (msg.includes('401') || msg.includes('403') || msg.includes('unauthorized') || msg.includes('forbidden')) {
                return { title: 'Session Expired', detail: 'Your login session has expired. Please log in again.' };
            }
            if (msg.includes('404') || msg.includes('not found')) {
                return { title: 'Not Found', detail: `The requested ${context || 'resource'} could not be found.` };
            }
            if (msg.includes('500') || msg.includes('server error')) {
                return { title: 'Server Error', detail: 'Something went wrong on the server. Please try again shortly.' };
            }
            if (msg.includes('network') || msg.includes('Failed to fetch') || msg.includes('NetworkError')) {
                return { title: 'Connection Error', detail: 'Unable to connect to the server. Check your internet connection.' };
            }
            return { title: `Error ${context ? 'with ' + context : ''}`, detail: msg };
        }

        // ===== RETRY WITH EXPONENTIAL BACKOFF =====
        async function fetchWithRetry(url, options, maxRetries = 3) {
            let lastError;
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const resp = await fetch(url, options);
                    if (resp.status === 429 && attempt < maxRetries) {
                        const waitMs = Math.min(1000 * Math.pow(2, attempt), 8000);
                        showToast(`Rate limited. Retrying in ${waitMs/1000}s...`, 'info');
                        await new Promise(r => setTimeout(r, waitMs));
                        continue;
                    }
                    return resp;
                } catch(err) {
                    lastError = err;
                    if (attempt < maxRetries && (err.message.includes('network') || err.message.includes('Failed to fetch'))) {
                        const waitMs = Math.min(1000 * Math.pow(2, attempt), 8000);
                        await new Promise(r => setTimeout(r, waitMs));
                        continue;
                    }
                    throw err;
                }
            }
            throw lastError;
        }

        // API FUNCTIONS
        // ============================================================================
        async function fetchList(listName) {
            try {
                const resp = await fetchWithRetry(`/api/sharepoint?site=client&list=${encodeURIComponent(listName)}`, {
                    credentials: 'include'
                });
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}: Failed to fetch ${listName}`);
                }
                const data = await resp.json();
                return data;
            } catch (error) {
                console.error(`Error fetching ${listName}:`, error);
                throw error;
            }
        }

        async function sendMessage(subject, body, matterID) {
            try {
                const resp = await fetchWithRetry('/api/sharepoint-write', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        site: 'client',
                        list: 'Messages',
                        fields: {
                            Title: subject,
                            Message_x0020_Body: body,
                            Matter_x0020_ID: matterID,
                            Priority: 'Normal',
                            Read: false,
                            SenderEmail: clientProfile.email
                        }
                    })
                });
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}: Failed to send message`);
                }
                return await resp.json();
            } catch (error) {
                console.error('Error sending message:', error);
                throw error;
            }
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // ============================================================================
        // INITIALIZATION & AUTH
        // ============================================================================
        async function initializePage() {
            try {
                const userEmail = getCookie('cq_user');
                if (!userEmail) {
                    window.location.href = '/login?type=client';
                    return;
                }
                const decodedEmail = decodeURIComponent(userEmail);
                clientProfile.email = decodedEmail.toLowerCase().trim();

                // Step 1: Resolve client identity from SharePoint Clients list
                await resolveClientProfile();

                // Display the client's name (or email as fallback)
                const displayName = clientProfile.name || decodedEmail;
                document.getElementById('userName').textContent = displayName;
                document.getElementById('userAvatar').textContent = getInitial(displayName);

                // Step 2: Pre-fetch all data and filter to this client
                await loadClientData();

                // Step 3: Render the dashboard with filtered data
                await loadDashboard();
                hideLoadingOverlay();
            } catch (error) {
                console.error('Initialization error:', error);
                hideLoadingOverlay();
                showError('Failed to initialize portal');
            }
        }

        /**
         * Resolve the logged-in user's email to a client profile from SharePoint.
         * Sets clientProfile.name and determines which matters belong to this client.
         */
        async function resolveClientProfile() {
            try {
                const clientsData = await fetchList('Clients');
                const clients = clientsData.items || [];

                const match = clients.find(c =>
                    (c.Email || '').toLowerCase().trim() === clientProfile.email
                );

                if (match) {
                    clientProfile.name = match.Title;
                    console.log('Client profile resolved:', clientProfile.name);
                } else {
                    console.warn('No matching client found for:', clientProfile.email);
                }
            } catch (error) {
                console.error('Failed to resolve client profile:', error);
            }
        }

        /**
         * Pre-fetch all SharePoint data and filter to only this client's records.
         * Uses the chain: Client Name ‚Üí Matters ‚Üí Matter IDs ‚Üí Messages/Events
         */
        async function loadClientData() {
            try {
                // Fetch all lists in parallel
                const [mattersData, messagesData, eventsData] = await Promise.all([
                    fetchList('Matters'),
                    fetchList('Messages'),
                    fetchList('Events')
                ]);

                const allMatters = mattersData.items || [];
                const allMessages = messagesData.items || [];
                const allEvents = eventsData.items || [];

                // Filter matters by client name
                const myMatters = clientProfile.name
                    ? allMatters.filter(m =>
                        (m.Client_x0020_Name || '').toLowerCase().trim() === clientProfile.name.toLowerCase().trim()
                    )
                    : [];

                // Build set of this client's matter identifiers for cross-filtering
                const myMatterTitles = new Set(myMatters.map(m => m.Title));
                const myMatterIds = new Set(myMatters.map(m => m.Matter_x0020_ID).filter(Boolean));
                // Also add matter titles as IDs since some records use Title as the reference
                myMatters.forEach(m => {
                    if (m.Title) myMatterIds.add(m.Title);
                    if (m.Matter_x0020_ID) myMatterIds.add(m.Matter_x0020_ID);
                });

                clientProfile.matterIds = [...myMatterIds];
                clientProfile.matterNames = [...myMatterTitles];

                // Filter messages by this client's matters
                const myMessages = allMessages.filter(msg => {
                    const msgMatter = msg.Matter_x0020_ID || '';
                    return myMatterIds.has(msgMatter);
                });

                // Filter events by this client's matters
                const myEvents = allEvents.filter(evt => {
                    const evtMatter = evt.Matter_x0020_ID || '';
                    return myMatterIds.has(evtMatter);
                });

                // Store filtered data
                portalData.matters = { items: myMatters, listName: 'Matters' };
                portalData.messages = { items: myMessages, listName: 'Messages' };
                portalData.events = { items: myEvents, listName: 'Events' };

                console.log(`Client data loaded: ${myMatters.length} matters, ${myMessages.length} messages, ${myEvents.length} events`);
            } catch (error) {
                console.error('Failed to load client data:', error);
                // Fallback: portalData stays empty, sections will show empty states
            }
        }

        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // ============================================================================
        // RENDER FUNCTIONS
        // ============================================================================
        async function loadDashboard() {
            const container = document.getElementById('dashboard');
            container.innerHTML = '<div class="loading-spinner"><div class="mini-spinner"></div></div>';

            try {
                // Use pre-filtered client-specific data from loadClientData()
                const mattersItems = (portalData.matters && portalData.matters.items) || [];
                const messagesItems = (portalData.messages && portalData.messages.items) || [];
                const eventsItems = (portalData.events && portalData.events.items) || [];

                const activeMatters = mattersItems.filter(m => m.Matter_x0020_Status === 'Active').length;
                const totalMatters = mattersItems.length;
                const unreadMessages = messagesItems.filter(m => !m.Read).length;
                const upcomingEvents = eventsItems.length;

                const welcomeName = clientProfile.name || 'Client';

                let html = `
                    <div class="card welcome-card">
                        <div class="card-title">Welcome, ${welcomeName}</div>
                        <p>Stay updated on your matters, documents, and billing information. Access all your legal matters in one secure location.</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalMatters}</div>
                            <div class="stat-label">Total Matters</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${activeMatters}</div>
                            <div class="stat-label">Active Matters</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${unreadMessages}</div>
                            <div class="stat-label">Unread Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${upcomingEvents}</div>
                            <div class="stat-label">Upcoming Events</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Quick Actions</div>
                        <div class="quick-links">
                            <button class="quick-link" onclick="switchTab('matters')">View Matters</button>
                            <button class="quick-link" onclick="switchTab('documents')">Documents</button>
                            <button class="quick-link" onclick="switchTab('calendar')">Calendar</button>
                            <button class="quick-link" onclick="switchTab('billing')">Billing</button>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error-message">Failed to load dashboard: ${error.message}</div>`;
            }
        }

        async function loadMatters() {
            const container = document.getElementById('matters');
            container.innerHTML = '<div class="loading-spinner"><div class="mini-spinner"></div></div>';

            try {
                const data = portalData.matters || await fetchList('Matters');
                portalData.matters = data;

                const matters = data.items || [];

                if (matters.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-title">No Matters Found</div><div class="empty-state-text">You currently have no matters.</div></div>';
                    return;
                }

                let html = '<div class="card"><div class="card-title">Your Matters</div><div class="table-responsive"><table>';
                html += '<thead><tr><th>Matter ID</th><th>Title</th><th>Status</th><th>Priority</th><th>Lead Lawyer</th><th>Practice Area</th></tr></thead><tbody>';

                matters.forEach((matter, index) => {
                    const status = matter.Matter_x0020_Status || 'Active';
                    const statusBadgeClass = `badge-${status.toLowerCase().replace(' ', '')}`;
                    const priority = matter.Priority || 'Normal';
                    const priorityBadgeClass = `badge-${priority.toLowerCase()}`;

                    html += `
                        <tr onclick="toggleMatterDetails(this, ${index})" style="cursor: pointer;">
                            <td>${matter.Matter_x0020_ID || 'N/A'}</td>
                            <td><strong>${matter.Title || 'Untitled'}</strong></td>
                            <td><span class="badge ${statusBadgeClass}">${status}</span></td>
                            <td><span class="badge ${priorityBadgeClass}">${priority}</span></td>
                            <td>${matter.Lead_x0020_Lawyer || matter.Client_x0020_Name || 'N/A'}</td>
                            <td>${matter.Practice_x0020_Area || 'N/A'}</td>
                        </tr>
                        <tr class="matter-details-row" style="display: none;">
                            <td colspan="6">
                                <div class="detail-row">
                                    <span class="detail-label">Description:</span>
                                    <span class="detail-value">${matter.Matter_x0020_Description || 'N/A'}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Fee Arrangement:</span>
                                    <span class="detail-value">${matter.Fee_x0020_Arrangement || 'N/A'}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Open Date:</span>
                                    <span class="detail-value">${formatDate(matter.Open_x0020_Date) || 'N/A'}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Target Close Date:</span>
                                    <span class="detail-value">${formatDate(matter.Target_x0020_Close_x0020_Date) || 'N/A'}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Last Updated:</span>
                                    <span class="detail-value">${formatDate(matter.Modified)}</span>
                                </div>
                                <div class="detail-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                    <button onclick="event.stopPropagation(); switchTab('documents');" class="btn btn-gold" style="padding: 6px 16px; font-size: 12px;">View Documents ‚Üí</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div></div>';
                container.innerHTML = html;
                checkTableOverflow();
            } catch (error) {
                container.innerHTML = `<div class="error-message">Failed to load matters: ${error.message}</div>`;
            }
        }

        async function loadDocuments() {
            const container = document.getElementById('documents');
            container.innerHTML = '<div class="loading-spinner"><div class="mini-spinner"></div></div>';

            try {
                const data = portalData.documents || await fetchList('Client Documents');
                portalData.documents = data;

                const documents = data.items || [];

                let html = '<div class="card"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><div class="card-title" style="margin: 0;">Documents</div><button class="btn btn-gold" onclick="openUploadModal()" style="padding: 8px 16px; font-size: 13px;">+ Upload Document</button></div>';
                html += '<p style="color: var(--gray-light); font-size: 13px; margin-bottom: 16px;">Click on any document to preview it</p><div style="display: flex; flex-direction: column; gap: 2px;">';

                // Add SharePoint documents
                documents.forEach((doc, idx) => {
                    const ext = (doc.Name || '').split('.').pop().toLowerCase();
                    const icon = ext === 'pdf' ? 'üìï' : (ext === 'docx' || ext === 'doc') ? 'üìò' : (ext === 'xlsx' || ext === 'xls') ? 'üìó' : ['png','jpg','jpeg','gif','svg','webp'].includes(ext) ? 'üñºÔ∏è' : 'üìÑ';
                    const size = doc.FileSizeDisplayString || doc.Size || '';
                    const sizeDisplay = size ? (typeof size === 'number' ? (size / 1024).toFixed(1) + ' KB' : size) : '';

                    html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.15s; border-radius: var(--radius-sm);" onmouseenter="this.style.background=\'#f8f6f0\'" onmouseleave="this.style.background=\'transparent\'" onclick="previewSharePointDoc(\'' + (doc.WebUrl || '#').replace(/'/g, "\\'") + '\', \'' + (doc.Name || doc.Title || 'Untitled').replace(/'/g, "\\'") + '\', \'' + sizeDisplay.replace(/'/g, "\\'") + '\')">';
                    html += '<div style="display: flex; align-items: center; gap: 10px;">';
                    html += '<span style="font-size: 18px;">' + icon + '</span>';
                    html += '<div>';
                    html += '<div style="font-size: 14px; font-weight: 500;">' + (doc.Name || doc.Title || 'Untitled') + '</div>';
                    html += '<div style="font-size: 11px; color: var(--gray-light);">' + formatDate(doc.TimeLastModified || doc.Modified) + (sizeDisplay ? ' ¬∑ ' + sizeDisplay : '') + '</div>';
                    html += '</div></div>';
                    html += '<span style="color: var(--gold); font-weight: 600; font-size: 12px;">View ‚Üí</span>';
                    html += '</div>';
                });

                if (documents.length === 0) {
                    html = '<div class="card"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><div class="card-title" style="margin: 0;">Documents</div><button class="btn btn-gold" onclick="openUploadModal()" style="padding: 8px 16px; font-size: 13px;">+ Upload Document</button></div><div class="empty-state"><div class="empty-state-icon">üìÑ</div><div class="empty-state-title">No Documents Found</div><div class="empty-state-text">There are no documents available yet. Upload your first document to get started.</div></div></div>';
                } else {
                    html += '</div></div>';
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="error-message">Failed to load documents: ' + error.message + '</div>';
            }
        }

        async function loadCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '<div class="loading-spinner"><div class="mini-spinner"></div></div>';

            try {
                const data = portalData.events || await fetchList('Events');
                portalData.events = data;

                const events = (data.items || []).sort((a, b) => {
                    const dateA = new Date(a.EventDate || a.Created);
                    const dateB = new Date(b.EventDate || b.Created);
                    return dateA - dateB;
                });

                // Get unique matters for filtering
                const uniqueMatters = [...new Set(events.map(e => e.Matter_x0020_ID).filter(Boolean))];

                if (events.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><div class="empty-state-title">No Events Found</div><div class="empty-state-text">There are no upcoming events.</div></div>';
                    return;
                }

                let html = '<div class="card"><div class="card-title">Calendar</div>';

                // Add filter
                if (uniqueMatters.length > 0) {
                    html += '<div class="filter-group"><label class="filter-label">Filter by Matter</label>';
                    html += '<select class="filter-select" id="eventMatterFilter" onchange="filterCalendarEvents()">';
                    html += '<option value="">All Matters</option>';
                    uniqueMatters.forEach(matter => {
                        html += `<option value="${matter}">${matter}</option>`;
                    });
                    html += '</select></div>';
                }

                html += '<div id="eventsList">';

                events.forEach(event => {
                    const category = event.Category || 'Event';
                    const matterRef = event.Matter_x0020_ID || '';

                    html += `
                        <div class="list-item event-item" data-matter="${matterRef}">
                            <div class="list-item-title">
                                ${event.Title || 'Untitled Event'}
                                ${matterRef ? `<span class="event-matter-ref">Matter: ${matterRef}</span>` : ''}
                            </div>
                            <div class="list-item-meta">
                                üìÖ ${formatDate(event.EventDate)} ${event.StartTime ? '‚è∞ ' + event.StartTime : ''} | üìç ${event.Location || 'TBD'}
                            </div>
                            <div style="margin-top: 8px;">
                                <span class="badge badge-normal">${category}</span>
                            </div>
                            ${event.Description ? `<div style="margin-top: 10px; font-size: 14px; color: var(--gray);">${event.Description}</div>` : ''}
                        </div>
                    `;
                });

                html += '</div></div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error-message">Failed to load calendar: ${error.message}</div>`;
            }
        }

        function filterCalendarEvents() {
            const filterValue = document.getElementById('eventMatterFilter')?.value || '';
            const events = document.querySelectorAll('.event-item');
            events.forEach(event => {
                if (!filterValue || event.getAttribute('data-matter') === filterValue) {
                    event.style.display = 'block';
                } else {
                    event.style.display = 'none';
                }
            });
        }

        async function loadMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '<div class="loading-spinner"><div class="mini-spinner"></div></div>';

            try {
                const data = portalData.messages || await fetchList('Messages');
                portalData.messages = data;

                let messages = data.items || [];

                // FIX 1: Sort messages by Created date descending (newest first)
                messages.sort((a, b) => new Date(b.Created) - new Date(a.Created));

                let html = '<div class="card"><div class="card-title">Messages</div>';
                html += '<button class="btn btn-gold" style="margin-bottom: 20px;" onclick="openMessageModal()">New Message</button>';
                html += '<div style="margin-bottom: 16px; display: flex; gap: 10px; align-items: center;">';
                html += '<input type="text" id="messageSearch" placeholder="Search messages..." style="flex:1; padding: 10px 14px; border: 1px solid var(--silver); border-radius: var(--radius-sm); font-size: 14px; font-family: inherit;" oninput="filterMessages()">';
                html += '<select id="messagePriorityFilter" onchange="filterMessages()" style="padding: 10px 14px; border: 1px solid var(--silver); border-radius: var(--radius-sm); font-size: 14px; font-family: inherit;"><option value="">All Priorities</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select>';
                html += '</div>';

                if (messages.length === 0) {
                    html += '<div class="empty-state"><div class="empty-state-icon">üí¨</div><div class="empty-state-title">No Messages</div><div class="empty-state-text">You have no messages at this time.</div></div>';
                } else {
                    messages.forEach((message, index) => {
                        const priority = message.Priority || 'Normal';
                        const priorityBadgeClass = `badge-${priority.toLowerCase()}`;

                        // FIX 3: Improve unread message styling
                        const unreadStyle = message.Read
                            ? ''
                            : 'border-left: 4px solid var(--gold); background: rgba(184, 134, 11, 0.12);';
                        const titleWeight = message.Read ? '500' : '700';

                        // FIX 2: Determine sender by checking SenderEmail field or comparing author email with client email
                        const clientEmail = clientProfile.email || '';
                        const senderEmail = message.SenderEmail || message.Author_x0020_Email || '';
                        const isClientMessage = senderEmail.toLowerCase() === clientEmail.toLowerCase();
                        const sender = isClientMessage ? 'You' : 'Staff';
                        const senderBadgeClass = isClientMessage ? 'sender-badge-client' : 'sender-badge-staff';

                        html += `
                            <div class="list-item" onclick="toggleMessageDetails(this, ${index})" style="${unreadStyle}">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div class="list-item-title" style="font-weight: ${titleWeight};">
                                            <span class="sender-badge ${senderBadgeClass}">${sender}</span>
                                            ${message.Title || 'No Subject'}
                                            ${!message.Read ? '<span style="display: inline-block; width: 8px; height: 8px; background: var(--gold); border-radius: 50%; margin-left: 8px; vertical-align: middle;"></span>' : ''}
                                        </div>
                                        <div class="list-item-meta">Matter: ${message.Matter_x0020_ID || 'N/A'} ‚Ä¢ <span title="${formatDate(message.Created)}">${timeAgo(message.Created)}</span></div>
                                    </div>
                                    <span class="badge ${priorityBadgeClass}">${priority}</span>
                                </div>
                                <div class="list-item-details" id="msg-details-${index}">
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--silver);">
                                        <div style="color: var(--gray); line-height: 1.6;">${message.Message_x0020_Body || 'No content'}</div>
                                        <div style="margin-top: 15px; font-size: 12px; color: var(--gray-light);">
                                            ${!message.Read ? '<span style="background: var(--gold); color: white; padding: 2px 8px; border-radius: 3px; margin-right: 10px;">Unread</span>' : ''}
                                            ${isClientMessage ? '<span style="background: rgba(184, 134, 11, 0.2); color: var(--gold-dark); padding: 2px 8px; border-radius: 3px; margin-right: 10px;">You sent this</span>' : ''}
                                            Received: ${formatDate(message.Created)}
                                        </div>
                                        ${!isClientMessage ? `<button class="btn btn-sm" style="margin-top: 15px; padding: 6px 12px; font-size: 12px; background: var(--gold); color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="event.stopPropagation(); replyToMessageClient('${(message.Title || 'Message').replace(/'/g, "\\'")}', '${(message.Matter_x0020_ID || 'N/A').replace(/'/g, "\\'")}')">Reply</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                html += '</div>';
                container.innerHTML = html;
                updateUnreadBadge();
            } catch (error) {
                container.innerHTML = `<div class="error-message">Failed to load messages: ${error.message}</div>`;
                updateUnreadBadge();
            }
        }

        async function loadBilling() {
            const container = document.getElementById('billing');
            container.innerHTML = '<div class="loading-spinner"><div class="mini-spinner"></div></div>';

            try {
                const data = portalData.billing || await fetchList('Billing');

                // Filter billing records to only this client's matters
                const allRecords = data.items || [];
                const myMatterIds = new Set(clientProfile.matterIds || []);
                const records = clientProfile.name
                    ? allRecords.filter(r => myMatterIds.has(r.MatterId || ''))
                    : allRecords;

                portalData.billing = { items: records, listName: 'Billing' };

                let totalBilled = 0;
                let totalPaid = 0;
                let totalOutstanding = 0;
                let totalOverdue = 0;
                let defaultCurrency = 'UGX';

                records.forEach(record => {
                    const amount = parseFloat(record.Amount) || 0;
                    const status = record.PaymentStatus || 'Pending';
                    const currency = record.Currency || 'UGX';

                    if (!defaultCurrency && record.Currency) {
                        defaultCurrency = record.Currency;
                    }

                    totalBilled += amount;

                    if (status === 'Paid') {
                        totalPaid += amount;
                    } else if (status === 'Overdue') {
                        totalOverdue += amount;
                    } else {
                        totalOutstanding += amount;
                    }
                });

                let html = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(totalBilled, defaultCurrency)}</div>
                            <div class="stat-label">Total Billed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(totalPaid, defaultCurrency)}</div>
                            <div class="stat-label">Paid</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(totalOutstanding, defaultCurrency)}</div>
                            <div class="stat-label">Outstanding</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(totalOverdue, defaultCurrency)}</div>
                            <div class="stat-label">Overdue</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Billing Records</div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Record Type</th>
                                        <th>Matter ID</th>
                                        <th>Amount</th>
                                        <th>Payment Status</th>
                                        <th>Due Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                if (records.length === 0) {
                    html += '<tr><td colspan="5" style="text-align: center; padding: 40px;">No billing records found</td></tr>';
                } else {
                    records.forEach(record => {
                        const status = record.PaymentStatus || 'Pending';
                        const statusBadgeClass = status === 'Paid' ? 'badge-paid' : status === 'Overdue' ? 'badge-overdue' : 'badge-pending';
                        const amount = parseFloat(record.Amount) || 0;
                        const currency = record.Currency || 'UGX';

                        html += `
                            <tr style="cursor: pointer; transition: background 0.15s;" onmouseenter="this.style.background='#f8f6f0'" onmouseleave="this.style.background='transparent'" onclick="showInvoiceModal(this)">
                                <td>${record.RecordType || 'Invoice'}</td>
                                <td>${record.MatterId || 'N/A'}</td>
                                <td><strong>${formatCurrency(record.Amount, currency)}</strong></td>
                                <td><span class="badge ${statusBadgeClass}">${status}</span></td>
                                <td>${formatDate(record.DueDate)}</td>
                            </tr>
                        `;
                    });
                }

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('Billing load error:', error.message);
                // Show friendly empty state if the Billing list isn't available yet
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">USh0.00</div>
                            <div class="stat-label">Total Billed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">USh0.00</div>
                            <div class="stat-label">Paid</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">USh0.00</div>
                            <div class="stat-label">Outstanding</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">USh0.00</div>
                            <div class="stat-label">Overdue</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Billing Records</div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Record Type</th>
                                        <th>Matter ID</th>
                                        <th>Amount</th>
                                        <th>Payment Status</th>
                                        <th>Due Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" style="text-align: center; padding: 40px; color: #888;">No billing records yet. Your invoices will appear here once generated by your legal team.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
        }

        // ============================================================================
        // EVENT HANDLERS
        // ============================================================================
        function switchTab(tabName) {
            currentTab = tabName;

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }

            switch (tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'matters':
                    loadMatters();
                    break;
                case 'documents':
                    loadDocuments();
                    break;
                case 'calendar':
                    loadCalendar();
                    break;
                case 'messages':
                    loadMessages();
                    break;
                case 'billing':
                    loadBilling();
                    break;
            }
        }

        function toggleMatterDetails(rowElement, index) {
            const detailRow = rowElement.nextElementSibling;
            if (detailRow && detailRow.classList.contains('matter-details-row')) {
                detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
            }
        }

        function toggleMessageDetails(element, index) {
            const detailsDiv = document.getElementById(`msg-details-${index}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('show');
            }
        }

        function replyToMessageClient(subject, matterId) {
            openMessageModal();
            // Pre-fill subject
            const subjectInput = document.getElementById('msgSubject');
            if (subjectInput) {
                subjectInput.value = subject.startsWith('Re: ') ? subject : 'Re: ' + subject;
            }
            // Pre-select and lock matter
            const matterSelect = document.getElementById('msgMatter');
            if (matterSelect && matterId && matterId !== 'N/A') {
                // Find and select the matter option
                for (let opt of matterSelect.options) {
                    if (opt.value === matterId) {
                        matterSelect.value = matterId;
                        break;
                    }
                }
                matterSelect.disabled = true;
            }
            // Focus body
            setTimeout(() => {
                const bodyTextarea = document.getElementById('msgBody');
                if (bodyTextarea) bodyTextarea.focus();
            }, 100);
        }

        function openMessageModal() {
            document.getElementById('messageModal').classList.add('show');
            // Reset disabled state for new messages
            document.getElementById('msgMatter').disabled = false;
            // Populate matter selector
            const matterSelect = document.getElementById('msgMatter');
            matterSelect.innerHTML = '<option value="">Select a matter...</option>';
            const matters = portalData.matters?.items || [];
            matters.forEach(matter => {
                const option = document.createElement('option');
                option.value = matter.Matter_x0020_ID || matter.Title || '';
                option.textContent = `${matter.Title || 'Untitled'}${matter.Matter_x0020_ID ? ' (' + matter.Matter_x0020_ID + ')' : ''}`;
                matterSelect.appendChild(option);
            });
        }

        function closeMessageModal() {
            document.getElementById('messageModal').classList.remove('show');
            document.getElementById('messageForm').reset();
            document.getElementById('msgMatter').disabled = false;
        }

        async function submitMessage(e) {
            e.preventDefault();
            const btn = document.querySelector('#messageModal button[type="submit"], #messageModal .btn-gold');
            setButtonLoading(btn, true);

            const subject = document.getElementById('msgSubject').value;
            const matterID = document.getElementById('msgMatter').value || document.getElementById('msgMatter').value;
            const body = document.getElementById('msgBody').value;

            try {
                showLoadingOverlay();
                await sendMessage(subject, body, matterID);
                closeMessageModal();
                showToast('Message sent successfully!', 'success');
                await loadMessages();
            } catch (error) {
                const errInfo = getContextualErrorMessage(error, 'message');
                showToast(`${errInfo.title}: ${errInfo.detail}`, 'error');
            } finally {
                hideLoadingOverlay();
                setButtonLoading(btn, false);
            }
        }

        function logout() {
            document.cookie = 'cq_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'cq_user=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const container = document.getElementById('content');
            const errorHtml = `<div class="error-message">${message}</div>`;
            container.insertAdjacentHTML('afterbegin', errorHtml);
            setTimeout(() => {
                container.querySelector('.error-message')?.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('content');
            const successHtml = `<div class="success-message">${message}</div>`;
            container.insertAdjacentHTML('afterbegin', successHtml);
            setTimeout(() => {
                container.querySelector('.success-message')?.remove();
            }, 5000);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // ============================================================================
        // DOCUMENT VIEWER
        // ============================================================================
        function previewSharePointDoc(url, name, size) {
            const ext = (name || '').split('.').pop().toLowerCase();
            const icon = ext === 'pdf' ? 'üìï' : (ext === 'docx' || ext === 'doc') ? 'üìò' : (ext === 'xlsx' || ext === 'xls') ? 'üìó' : ['png','jpg','jpeg','gif','svg','webp'].includes(ext) ? 'üñºÔ∏è' : 'üìÑ';
            const modal = document.getElementById('docViewerModal');
            const content = document.getElementById('docViewerContent');
            const downloadBtn = document.getElementById('docViewerDownload');
            const openBtn = document.getElementById('docViewerOpenNew');

            document.getElementById('docViewerIcon').textContent = icon;
            document.getElementById('docViewerTitle').textContent = name || 'Document';
            document.getElementById('docViewerMeta').textContent = size || 'SharePoint';

            if (url && url !== '#') {
                downloadBtn.href = url;
                downloadBtn.style.display = 'inline-block';
                openBtn.href = url;
                openBtn.style.display = 'inline-block';
            } else {
                downloadBtn.style.display = 'none';
                openBtn.style.display = 'none';
            }

            // Render based on file type
            if (['png','jpg','jpeg','gif','svg','webp','bmp'].includes(ext) && url && url !== '#') {
                content.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; padding: 20px; min-height: 300px; background: #f8f8f8;"><img src="' + escapeHtml(url) + '" alt="' + escapeHtml(name || 'Image') + '" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 4px; box-shadow: 0 2px 12px rgba(0,0,0,0.1);" onerror="this.parentElement.innerHTML=\'<div style=\\\'text-align:center;color:#888;padding:40px;\\\'>Unable to load image preview.<br><a href=\\\'' + escapeHtml(url) + '\\\' target=\\\'_blank\\\' style=\\\'color:var(--gold);\\\'>Open in new tab</a></div>\'"></div>';
            } else if (ext === 'pdf' && url && url !== '#') {
                content.innerHTML = '<iframe src="' + escapeHtml(url) + '" style="width: 100%; height: 70vh; border: none;"></iframe><div style="text-align: center; padding: 8px; background: #e8e8e8; font-size: 12px; color: #666;">If the PDF doesn\'t load, <a href="' + escapeHtml(url) + '" target="_blank" style="color: var(--gold);">open it in a new tab</a></div>';
            } else {
                content.innerHTML = '<div style="padding: 60px 40px; text-align: center; color: #555;"><div style="font-size: 48px; margin-bottom: 16px;">' + icon + '</div><h4 style="font-size: 16px; margin-bottom: 8px;">' + escapeHtml(name || 'Document') + '</h4><p style="font-size: 13px; color: #888; margin-bottom: 20px;">This document is stored on SharePoint.</p><a href="' + escapeHtml(url || '#') + '" target="_blank" class="btn btn-gold" style="text-decoration: none; padding: 10px 24px;">Open in SharePoint</a></div>';
            }

            modal.classList.add('show');
        }

        function closeDocViewer() {
            document.getElementById('docViewerModal').classList.remove('show');
            document.getElementById('docViewerContent').innerHTML = '';
            document.getElementById('docViewerOpenNew').style.display = 'none';
        }

        function showToast(message, type) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const colors = { success: '#2e7d32', error: '#c62828', warning: '#e65100', info: '#1565c0' };
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.style.cssText = 'display:flex;align-items:center;gap:10px;padding:12px 20px;background:' + (colors[type] || colors.info) + ';color:#fff;border-radius:8px;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);animation:slideIn 0.3s ease forwards;min-width:250px;';
            toast.innerHTML = '<span style="font-size:16px;">' + (icons[type] || icons.info) + '</span><span style="flex:1;">' + message + '</span><button onclick="this.parentElement.remove()" style="background:none;border:none;color:#fff;cursor:pointer;font-size:16px;padding:0 0 0 8px;">√ó</button>';
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentElement) toast.remove(); }, 4000);
        }

        // ============================================================================
        // DOCUMENT UPLOAD
        // ============================================================================
        async function openUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('show');

            // Populate matter dropdown
            const matterSelect = document.getElementById('uploadMatter');
            matterSelect.innerHTML = '<option value="">-- Choose a matter --</option>';

            try {
                const data = portalData.matters || await fetchList('Matters');
                const matters = data.items || [];
                matters.forEach(matter => {
                    const option = document.createElement('option');
                    option.value = matter.Matter_x0020_ID || matter.Title || '';
                    option.textContent = `${matter.Title || 'Untitled'}${matter.Matter_x0020_ID ? ' (' + matter.Matter_x0020_ID + ')' : ''}`;
                    matterSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading matters:', error);
            }
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
            document.getElementById('uploadForm').reset();
            document.getElementById('fileName').textContent = '';
            document.getElementById('uploadProgress').style.display = 'none';
        }

        let selectedFile = null;

        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
        }

        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        function handleFileSelect(file) {
            selectedFile = file;
            document.getElementById('fileName').textContent = '‚úì ' + file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)';
            document.getElementById('uploadArea').style.borderColor = 'var(--gold)';
        }

        async function submitUpload(e) {
            if (e && e.preventDefault) e.preventDefault();

            const btn = document.querySelector('#uploadModal button[type="submit"], #uploadModal .btn-gold');
            setButtonLoading(btn, true);

            if (!selectedFile) {
                showToast('Please select a file', 'error');
                setButtonLoading(btn, false);
                return;
            }

            const matterSelect = document.getElementById('uploadMatter');
            const matterId = matterSelect ? matterSelect.value : '';
            if (!matterId) {
                showToast('Please select a matter', 'error');
                setButtonLoading(btn, false);
                return;
            }

            // Find matter title
            const matter = (portalData.matters?.items || []).find(m =>
                (m.Matter_x0020_ID || m.Title || '') === matterId
            );
            const matterTitle = matter ? (matter.Title || matterId) : matterId;

            // Validate file type
            const allowedTypes = ['pdf','docx','xlsx','png','jpg','jpeg','txt','csv','msg'];
            const ext = selectedFile.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(ext)) {
                showToast('File type not allowed. Accepted: ' + allowedTypes.join(', '), 'error');
                setButtonLoading(btn, false);
                return;
            }

            try {
                // Read file as base64
                const fileData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1]; // Remove data:...;base64, prefix
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(selectedFile);
                });

                const resp = await fetchWithRetry('/api/upload-document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileName: selectedFile.name,
                        fileData: fileData,
                        matterId: matterId,
                        matterTitle: matterTitle
                    }),
                    credentials: 'include'
                });

                if (resp.ok) {
                    const result = await resp.json();
                    showToast('Document uploaded successfully to SharePoint', 'success');
                    closeUploadModal();
                    selectedFile = null;
                    // Refresh documents
                    await loadClientData();
                    switchTab('documents');
                } else {
                    const err = await resp.json();
                    showToast('Upload failed: ' + (err.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                const errInfo = getContextualErrorMessage(error, 'document');
                showToast(`${errInfo.title}: ${errInfo.detail}`, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function previewLocalDoc(dataUrl, name, size) {
            const ext = (name || '').split('.').pop().toLowerCase();
            const icon = ext === 'pdf' ? 'üìï' : (ext === 'docx' || ext === 'doc') ? 'üìò' : (ext === 'xlsx' || ext === 'xls') ? 'üìó' : ['png','jpg','jpeg','gif','svg','webp'].includes(ext) ? 'üñºÔ∏è' : 'üìÑ';
            const modal = document.getElementById('docViewerModal');
            const content = document.getElementById('docViewerContent');
            const downloadBtn = document.getElementById('docViewerDownload');

            document.getElementById('docViewerIcon').textContent = icon;
            document.getElementById('docViewerTitle').textContent = name || 'Document';
            document.getElementById('docViewerMeta').textContent = size || 'Local';

            downloadBtn.style.display = 'inline-block';
            downloadBtn.href = dataUrl;
            downloadBtn.download = name;

            if (['png','jpg','jpeg','gif','svg','webp','bmp'].includes(ext)) {
                content.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; padding: 20px; min-height: 300px; background: #f8f8f8;"><img src="' + dataUrl + '" alt="' + (name || 'Image') + '" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 4px; box-shadow: 0 2px 12px rgba(0,0,0,0.1);"></div>';
            } else {
                content.innerHTML = '<div style="padding: 60px 40px; text-align: center; color: #555;"><div style="font-size: 48px; margin-bottom: 16px;">' + icon + '</div><h4 style="font-size: 16px; margin-bottom: 8px;">' + (name || 'Document') + '</h4><p style="font-size: 13px; color: #888; margin-bottom: 20px;">This is a locally uploaded document.</p><button onclick="downloadLocalFile(\'' + dataUrl.replace(/'/g, "\\'") + '\', \'' + name.replace(/'/g, "\\'") + '\')" class="btn btn-gold" style="padding: 10px 24px;">Download</button></div>';
            }

            modal.classList.add('show');
        }

        function downloadLocalFile(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ============================================================================
        // INVOICE MODAL
        // ============================================================================
        function showInvoiceModal(rowElement) {
            const cells = rowElement.querySelectorAll('td');
            if (cells.length < 5) return;

            const recordType = cells[0].textContent || 'Invoice';
            const matterId = cells[1].textContent || 'N/A';
            const amount = cells[2].textContent || 'UGX 0';
            const status = cells[3].textContent || 'Pending';
            const dueDate = cells[4].textContent || 'N/A';

            // Find the full record from portalData
            const records = (portalData.billing && portalData.billing.items) || [];
            const record = records.find(r =>
                (r.RecordType || 'Invoice') === recordType &&
                (r.MatterId || 'N/A') === matterId
            );

            let html = `
                <div class="invoice-header">
                    <div>
                        <div class="invoice-title">Invoice</div>
                        <div style="color: var(--gray-light); font-size: 13px; margin-top: 4px;">${record?.InvoiceNumber || 'INV-' + Date.now()}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--gold);">${amount}</div>
                        <div style="font-size: 12px; color: var(--gray-light); margin-top: 4px;">
                            <span class="badge ${status === 'Paid' ? 'badge-paid' : status === 'Overdue' ? 'badge-overdue' : 'badge-pending'}">${status}</span>
                        </div>
                    </div>
                </div>

                <div class="invoice-info-grid">
                    <div class="invoice-info-item">
                        <div class="invoice-info-label">Matter ID</div>
                        <div class="invoice-info-value">${matterId}</div>
                    </div>
                    <div class="invoice-info-item">
                        <div class="invoice-info-label">Invoice Date</div>
                        <div class="invoice-info-value">${record?.InvoiceDate ? formatDate(record.InvoiceDate) : formatDate(record?.Created)}</div>
                    </div>
                    <div class="invoice-info-item">
                        <div class="invoice-info-label">Due Date</div>
                        <div class="invoice-info-value">${dueDate}</div>
                    </div>
                    <div class="invoice-info-item">
                        <div class="invoice-info-label">Record Type</div>
                        <div class="invoice-info-value">${recordType}</div>
                    </div>
                </div>

                <div class="invoice-items">
                    <table class="invoice-items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th style="text-align: right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${record?.Description || recordType + ' for Matter ' + matterId}</td>
                                <td style="text-align: right; font-weight: 600;">${amount}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="invoice-totals">
                    <div class="invoice-total-row">
                        <span>Subtotal</span>
                        <span>${amount}</span>
                    </div>
                    <div class="invoice-total-row">
                        <span>Tax (0%)</span>
                        <span>${amount.startsWith('UGX') ? 'UGX 0' : '$0.00'}</span>
                    </div>
                    <div class="invoice-total-row final">
                        <span>Total Due</span>
                        <span>${amount}</span>
                    </div>
                </div>

                <div class="invoice-actions">
                    <button class="btn btn-secondary" onclick="window.print()">Print</button>
                    <button class="btn btn-gold" onclick="downloadInvoicePDF()">Download PDF</button>
                </div>
            `;

            document.getElementById('invoiceContent').innerHTML = html;
            document.getElementById('invoiceModal').classList.add('show');
        }

        function downloadInvoicePDF() {
            showToast('PDF download feature coming soon', 'info');
        }

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function () {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
        document.getElementById('messageForm').addEventListener('submit', submitMessage);
        document.getElementById('closeMessageModal').addEventListener('click', closeMessageModal);
        document.getElementById('cancelMessageBtn').addEventListener('click', closeMessageModal);

        document.getElementById('uploadForm').addEventListener('submit', submitUpload);
        document.getElementById('closeUploadModal').addEventListener('click', closeUploadModal);
        document.getElementById('cancelUploadBtn').addEventListener('click', closeUploadModal);
        document.getElementById('closeInvoiceModal').addEventListener('click', () => {
            document.getElementById('invoiceModal').classList.remove('show');
        });

        document.getElementById('contentWrapper').addEventListener('click', function () {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        });

        document.getElementById('messageModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeMessageModal();
            }
        });

        document.getElementById('uploadModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeUploadModal();
            }
        });

        document.getElementById('invoiceModal').addEventListener('click', function (e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });

        // Document viewer close handlers
        document.getElementById('docViewerModal').addEventListener('click', function(e) {
            if (e.target === this) closeDocViewer();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('docViewerModal').classList.contains('show')) {
                    closeDocViewer();
                }
                if (document.getElementById('uploadModal').classList.contains('show')) {
                    closeUploadModal();
                }
                if (document.getElementById('invoiceModal').classList.contains('show')) {
                    document.getElementById('invoiceModal').classList.remove('show');
                }
            }
        });

        // ============================================================================
        // INITIALIZE
        // ============================================================================
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
